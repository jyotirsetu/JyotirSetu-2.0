---
import AdminLayout from '../../admin/layouts/AdminLayout.astro';
---

<AdminLayout title="Change Password">
  <div style="max-width: 40rem; margin: 0 auto;">
    <!-- Header -->
    <div style="margin-bottom: 2rem;">
      <h1 style="font-size: 1.875rem; font-weight: bold; color: #f8fafc; margin: 0; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">Change Password</h1>
      <p style="color: #cbd5e1; margin-top: 0.5rem; margin-bottom: 0;">Update your admin password for security</p>
    </div>
    
    <!-- Password Change Form -->
    <div class="admin-card" style="padding: 2rem;">
      <form id="changePasswordForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #cbd5e1; margin-bottom: 0.5rem;">Current Password</label>
          <input 
            type="password" 
            id="currentPassword" 
            name="currentPassword" 
            style="width: 100%; padding: 0.75rem 1rem; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.5rem; background: rgba(15, 23, 42, 0.8); color: #f8fafc; font-size: 0.875rem; transition: all 0.3s ease; backdrop-filter: blur(10px);"
            placeholder="Enter your current password"
            required
          />
        </div>
        
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #cbd5e1; margin-bottom: 0.5rem;">New Password</label>
          <input 
            type="password" 
            id="newPassword" 
            name="newPassword" 
            style="width: 100%; padding: 0.75rem 1rem; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.5rem; background: rgba(15, 23, 42, 0.8); color: #f8fafc; font-size: 0.875rem; transition: all 0.3s ease; backdrop-filter: blur(10px);"
            placeholder="Enter your new password"
            required
            minlength="6"
          />
          <p style="color: #94a3b8; font-size: 0.75rem; margin-top: 0.25rem;">Password must be at least 6 characters long</p>
        </div>
        
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #cbd5e1; margin-bottom: 0.5rem;">Confirm New Password</label>
          <input 
            type="password" 
            id="confirmPassword" 
            name="confirmPassword" 
            style="width: 100%; padding: 0.75rem 1rem; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.5rem; background: rgba(15, 23, 42, 0.8); color: #f8fafc; font-size: 0.875rem; transition: all 0.3s ease; backdrop-filter: blur(10px);"
            placeholder="Confirm your new password"
            required
          />
        </div>
        
        <div id="messageContainer"></div>
        
        <div style="display: flex; gap: 1rem;">
          <button type="submit" class="admin-btn-primary" id="changePasswordBtn" style="flex: 1;">
            Change Password
          </button>
          <a href="/admin/dashboard" class="admin-btn-primary" style="flex: 1; text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center;">
            Cancel
          </a>
        </div>
        
        <!-- Forgot Password Link -->
        <div style="text-align: center; margin-top: 1rem;">
          <a href="/admin/forgot-password" style="color: #60a5fa; font-size: 0.875rem; text-decoration: none; transition: color 0.3s ease;" onmouseover="this.style.color='#93c5fd'" onmouseout="this.style.color='#60a5fa'">
            Don't know your current password? Reset it here
          </a>
        </div>
      </form>
    </div>
    
    <!-- Security Tips -->
    <div class="admin-card" style="padding: 1.5rem; margin-top: 1.5rem;">
      <h3 style="font-size: 1.125rem; font-weight: 600; color: #f8fafc; margin: 0 0 1rem 0; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">Security Tips</h3>
      <ul style="color: #cbd5e1; font-size: 0.875rem; list-style: none; padding: 0; margin: 0;">
        <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg style="width: 1rem; height: 1rem; color: #10b981; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Use a strong password with at least 8 characters
        </li>
        <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg style="width: 1rem; height: 1rem; color: #10b981; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Include uppercase, lowercase, numbers, and symbols
        </li>
        <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg style="width: 1rem; height: 1rem; color: #10b981; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Don't reuse passwords from other accounts
        </li>
        <li style="display: flex; align-items: center; gap: 0.5rem;">
          <svg style="width: 1rem; height: 1rem; color: #10b981; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Change your password regularly
        </li>
      </ul>
    </div>
  </div>
  
  <!-- Password Change Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('changePasswordForm') as HTMLFormElement;
      if (!form) return;
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const currentPasswordInput = document.getElementById('currentPassword') as HTMLInputElement;
        const newPasswordInput = document.getElementById('newPassword') as HTMLInputElement;
        const confirmPasswordInput = document.getElementById('confirmPassword') as HTMLInputElement;
        const changePasswordBtn = document.getElementById('changePasswordBtn') as HTMLButtonElement;
        const messageContainer = document.getElementById('messageContainer') as HTMLDivElement;
        
        if (!currentPasswordInput || !newPasswordInput || !confirmPasswordInput || !changePasswordBtn || !messageContainer) {
          console.error('Required form elements not found');
          return;
        }
        
        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // Validate passwords match
        if (newPassword !== confirmPassword) {
          messageContainer.innerHTML = `
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem;">
              New passwords do not match
            </div>
          `;
          return;
        }
        
        // Validate password length
        if (newPassword.length < 6) {
          messageContainer.innerHTML = `
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem;">
              Password must be at least 6 characters long
            </div>
          `;
          return;
        }
        
        // Show loading state
        changePasswordBtn.disabled = true;
        changePasswordBtn.textContent = 'Changing Password...';
        messageContainer.innerHTML = '';
        
        try {
          const response = await fetch('/admin/api/change-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
              currentPassword, 
              newPassword 
            }),
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Show success message
            messageContainer.innerHTML = `
              <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #6ee7b7; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem;">
                Password changed successfully! Redirecting to dashboard...
              </div>
            `;
            
            // Clear form
            form.reset();
            
            // Redirect to dashboard
            setTimeout(() => {
              window.location.href = '/admin/dashboard';
            }, 2000);
          } else {
            // Show error message
            messageContainer.innerHTML = `
              <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem;">
                ${data.message || 'Failed to change password'}
              </div>
            `;
          }
        } catch (error) { // eslint-disable-line @typescript-eslint/no-unused-vars
          messageContainer.innerHTML = `
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem;">
              An error occurred. Please try again.
            </div>
          `;
        } finally {
          // Reset button state
          changePasswordBtn.disabled = false;
          changePasswordBtn.textContent = 'Change Password';
        }
      });
    });
  </script>
</AdminLayout>
